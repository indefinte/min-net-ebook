<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!--> <html lang="en"> <!--<![endif]-->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script type="text/javascript" src="js/extras/jquery.min.1.7.js"></script>
<script type="text/javascript" src="js/extras/jquery-ui-1.8.20.custom.min.js"></script>
<script type="text/javascript" src="js/extras/jquery.ui.draggable.min.js"></script>
<script type="text/javascript" src="js/extras/jquery.ui.touch-punch.min.js"></script>
<script type="text/javascript" src="js/extras/jquery.mousewheel.min.js"></script>
<script type="text/javascript" src="js/extras/modernizr.2.5.3.min.js"></script>
<script type="text/javascript" src="js/lib/hash.js"></script>

<!--[if IE]><script type="text/javascript" src="js/excanvas.js"></script><![endif]-->

<style>
	body { margin: 0; padding: 0; }
	#bookDiv { position: absolute; }
	#noteDiv { position: absolute; width: 960px; height: 600px; z-index: 9999; left: 0; top: 0; display: none; }
	.bGroup { position: absolute; left: 0; top: 0; }
	.btn {
		float: left;
		cursor: pointer;
		border: 1px solid #5252FF;		
		width: 32px;
		height: 32px;
		text-align: center;
		line-height: 32px;
		-webkit-border-radius: 16px;
		-moz-border-radius: 16px;
		border-radius: 16px;
		margin-right: 2px;		
	}	
	.bExt { display: none; }
	.bZoom.clk { background-color: #CAFF7A; }
	.bNote.clk { background-color: #CCE6FF; }
	.bTool.clk { background-color: #CCE6FF; }
	.bZoom { color: #003870; background-color: #B1FF3D; background-repeat: no-repeat; background-position: center; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAAADdAAAA3QFwU6IHAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAHVQTFRF////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANuvKZAAAACZ0Uk5TAAIFBggLFhobKzA9S05QYWp2f4CDh7Cyt7jExcbJy9Dd5ebw+v1b20x6AAABBElEQVQ4y62S0WKCMAxFM0SKClaRyVAEhXr+/xP3AEjbobzsvqX3tEmTiPSKkqxo2yJLIplTcDIMMlnw1982WGq2vn8wQJWnSqV5BZiDd99Ap8dId2CcN4IGLrGsj+eHiIjEF2jsOk7QxbK7A/1B3EE2+ZEBLbsn170as4CZfptAJes731/TpQqSV5BBLkeuli+5naOAVM7s7bpTKF5BC0oeKBtQ0LqAJwcoIPUBJ0UGuQ84RSZQ+YDzzb5RjtxGDa225LV6HNbk+8OaH/cm/Lwwqi3DTysX3sAhvKVVN/AIZ+03bc/+hDKvsBxeK/+DWC0RWhaIWhaI98BA6PeArHRd6+AXafgqvsE/FT0AAAAASUVORK5CYII41f3ddf9e98fb50824737ec401e7f2e0'); }		
	.bNote { color: #003870; background-color: #29B8FF; background-repeat: no-repeat; background-position: center; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAYCAYAAACbU/80AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOFAAADhQBBi3XKwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAOZSURBVEiJrdZZ6FdVEAfwz+g/t8iFMjVXcC0rNBAEowSlJMmMouXBwJbHhIJK8KFIopcEy0BKioIgkgiywkoM24ikzTYyNXPXRFJS01ymh3OK66+fKw1c7rnnzsz5nu/MnDmRmSKiEyZiGkZgCAaiG/bgB/xYn1WZuVsbiYjzMAVjcVl9D8Fx7MRmbMKHWJGZB6ICmIO78TI+xVbsysxjEXFhw+HlmIFnsTAz/2osPh1P4TusboDenJlZ/QzAVZiJbpl5g8yEBzA3M53uQV88h7XV0Rgsx0cYf4Y+xuHdOrYYh5sA0LXudhxGoeMkTr7FPtx2koU6MBQ929geqIzJ+sytP1/C0cZ8Vvo/w4Ia405VdyF+agF+K97AJ1hZw/omPqjf/SqARHa0yaX+6NwydxDX4jrMwn24o6kQERMrwLcwJzO31vmumXm4RXfAP+N2ANpJD7yOFZifmRva6HyemZMiYgIejIix6ILDEdGl6hzBXU2jMwVwUKmSW7AkIrZl5qwWnfER8TTWKLR/k5lHmgxEREdmHj1XBp5XGLgf69rofI+pmIDZGBMRHTjYZCAizpmBO3GzEufdSi405Uo8o5wBL2JNZh5pKpwNA0fwSx33UGI5T6n3m3Csjc0aJVF7KqGaHRGjcX7V34MtEfFY06gdgHuVU7AV/VLcjkVKWT3SYjcc89ELS7EE6zLzQLXvjUvwOwadCsAUTI+IixDohP1Yj/fxEAa3sdtZ//1RGbgHwyOih9ILdmMLnjwdA8vxdmbuaez+AoxW+sA8vIMnWuz6tzDwQgsDfevO9zU30A7AZEyNiMHV2VFsVM7+ZXhU6ZiU07FXCwO7cGNlYWRE9FOSeGtl4NfTMbAaX2NHZu6PiM5KSx2hHCILlENpXWa+FhH7ql0fPIwrlBxZicWZuT0iutfdD1LCeUoAozEJgyNiIA4pdb9eScBNSqNqlT+V8vsSV1cgMyNiqEL7NmyvmzslgB14T6Fsu1KGoyqwx5V2/Aq+arHrrLTnRUoj+kIJ0Ub0bjBwqHXBE7rhGfTyXpjc+J5W34NxPTqf4X3gpN1QRPTBpdiLDc1ulpn7sOo/u8jcoiRZ0093jMTFWFt1TpAmgBkRcY0Su0GN+eMRsUnJg5+VK9eyzNzZslgvJQQTlHCNqqxEQ2ev0jN++3euUnG2chwfK/U+HMMwXbmQnJWcK4D/TUK5ip+LDFM65FC8qlxKj5+tk78Bwingl11imTYAAAAASUVORK5CYII0f2f66e8b4f46b5c4f7814321a33e8da'); }		
	.bTool { color: #003870; background-color: #29B8FF; background-repeat: no-repeat; background-position: center; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOcAAADnABlNk0xAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAANsSURBVFiFtddLbFVVFAbgLyCoiQktDwtUKI9Ci0aM1miMEMUHA02MDBACRKJOjHHmAHWgiTpwYIw6deAjYWZMDCZGJzIxURShIshDwQLVoMFqW1oNkOtgrxtujvvec1rsYKe3Z52z/v+s/f9rr6NWq5nKhVn4FH3ZeIUE0y4DvA17UMNZrJ4QAXTgW6yfJPjXuIhXMIQz6K1EIMAPYQRjuHcC4O34JsC3x7XbMYxBdLckgGtxEIfRifdwDndXAJ+NvQH+aCG2BqMYQFeWAObhexzFwoZqjMTDa1uAz8E+XMC2Qmxm/F0XFf0JncUEc3EAx9DZkLQ/hFQLInc2Ad8f4FsKsW6cwKr4f0fk2p2zzFc4hWVRzn0N4PU1jDsKxPsDfHOT6ryOX/BYVHIQPc18uwc/NwGvr79wG66I+87jkUy+a/BC3PdhPHsaK1qJsC1U3Ay8voZwK7ZjYyFHH6aHfo7gM0nIp5S5oMFKeyuQ+AO3FJ6dFluyM35vi3tPYtlEGlG71IjKSJzFTYVnOyWlf4Lx2NKl/8Go6Ov9FUj8jhvjjT/HA3giYiewJJu/YmcrWrHZ+g03YGvs999RhcVNc1ch0GC17yqQOINVQeIIFrXMWxH8OryFhVKXLCPxK3pE97ssAlgUZRwPa9XPiTISg8LrkyaALhwP8PUN1zvwQwUSp7F8UgSwJNQ7hvsz8fnSaVlG4mTOfi0JYKnk2zHcl4k/jFexIIRWRuJLzK9EQDqEBsJG9zRcvwovYiaul3z/cgjzWAmBx/F8KQEsl3r1OawrxNqlhvQRZuC5SP5UuOTHDPCAdEj1YldLAlgRohmVmXywWBpWDuKLSHzUpbmh7pZGAhtxpXQSvoSbswSwUrLNKO5qIrhhbMKTkfywmJgKJI/jXbyNrQ2xlXgtk1uPNCiMKIxb+Bib4veDsTXnpWE1L6pk3Q/wDGYVYrsUxnzYHW+0I5Nsg+SEDVJrvRBb0FHaYFiL9/GGNJI9hH8UXMWlY3OsUXjSGb4gyj4e4Acwrww8I+w38We86Ds5DXSFYkexJq7tjFI/HeD9mDsR8IyLno2cV+dc0B1CHJY+IqZLA2pNmvnmTBa8QGRGlkAEe6XjdEj6nLoojWWz/w/wLKEMw9XSiFWTvu3apwo8SyBI9Emf1G1TCV6r1fwLxnxqIp0rcv8AAAAASUVORK5CYIIb52c395bd5726a2c2abdd0c57e612184'); }		
	.bClear { color: #003870; background-color: #E0E0E0; background-repeat: no-repeat; background-position: center; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAAACOAAAAjgFr39bJAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAWVQTFRF////AAAAAAAAAAAAMwAAJAAAHBwAGhoaIBAQHA4OGw0NGg0NGAwMIBULHxQKHBMJGxIJGhIJIhERIBAQHw8PHg8PHQ8PIRQNHxMMHhIMIRALHxAKHRQPHBMOHhENHhENHRAMHBAMHxQMHhMLHRIPHRIOHBIOHxEOHxMNHhIMHhIMHRIMHREMHREOHhMOHxINHxINHxINHhEMHREMHREMHxMMHxMOHhIOHhIOHRIOHhENHhENHxIMHhIOHxEOHxENHhMNHhMNHRINHhIMHhEMHREMHxMOHhINHhINHRINHxINHhINHhENHhMNHhIOHhINHhINHhENHhMNHhINHhIOHhINHhINHhINHhINHhMOHhIOHRINHxINHhINHhINHhINHhINHhINHhINHhMNHhINHhINHhINHhINHhINHhINHhINHhINHhINHhINHhIMHhINHhMNHhINHhINHhINHhINHhINHhINCJ03twAAAHZ0Uk5TAAECBAUHCQoQEhMUFRgZGxwdHiAhIiMnKSovMTQ3Ozw+P0FDRkdISlFUVVdYWV5iY2RnaGprbG9wcXZ4fYGEhYiJi5GSk5aYmpyeoKKjqqussLK0u73DxMXOz9DR0tPU1tfY3N7f4+Tm6e7v8vP19vj5+vv9/mqvdrkAAAE2SURBVBgZpcGHNwJxAAfwrwauOoQrI1tGUmRnZlQ4e8sKUcq++/79xsPF0+95z+eD/wjuOSBiz9ENkVluQUS+1+shssA1iDgftFqIxLkCEdfzswsiKuMQqdEenBBZ5TxE6vQ7GSKbjEDEw5wNApWSfwSFtSZ5H0Zh4zpJXUEBVpXvIviVMpN5TPPNNn4w2xuHFg/0zKRsDpyTXIZBSqXTdyRvd+f8Vrwy+RKcgsFyeTHW5/O6TfjiYAh5+p+ayivdMgxtbEceyz5TalcxDNNZK5RoCJ+kZGJoYHi0AR/kXAxYJz34VLHDq8EqAI5uCYB6IwMxagoM/dnj4Ej0JNMJSBtaL4CSQD3yla3r5KFi75i4um4BSgHUmfCNM3xEnUwt2QDvqQnms2b8VN3jteFNkQKgGH/yApnFP0hF+CCUAAAAAElFTkSuQmCC6fb01dc86583aac0c8b381ad08800158'); }
	.bEraser { color: #003870; background-color: #E0E0E0; background-repeat: no-repeat; background-position: center; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAAAxklEQVR4Ae3Qvy7DURjH4UdSnEoTcxEJt0HiBmy6mhCT23ETQpEQ/zqZjCZ/egEGV1BdLO/Q+CV6eubzOfPzzckrq1ptyb5EOR8YuZPK+ZVNw5go4gtYi4lCDjFRxAsm4nQb8Gein8uvDQytmmzejVtTW4zPtz35tDLBLz3rmNq6sRPQ9uhDN/hFHoeeH8cgefCuq+U8uPyJI5Dce9OfjUPPyCHo+A5u9okDLWfBlU28+LJrJ96WRnP+a8+pZRHGtr2q1Rr9ArTCOTSbwKWTAAAAAElFTkSuQmCC48d27f5a3722594e846bd3d5eaae4ffa'); }
	.bMarker { color: #003870; background-color: #2E8A5C; background-repeat: no-repeat; background-position: center; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAABKElEQVR4Ae3Bz8vLcRwA8Jfs4fEc0NPTc/AgKzkQOTyn5eDHDkoOu+3gx0qRsnLm6rLLDlKWg9yURO1Ju7hpqT0lDaHEwVqjZs3aNwd8/A1vB6X2epn5bxScNu+v3fTDZ99dEIeyb/IoGaoI267lg/2gYGSbkDkdI0nmInbI5ITUvLbVPUny0CNrQoqmDtqs676+5JWdApb0XUFdR84RyW4ha5oomthnkxduCanqW7Ko5xLquuYFHJI5gQeaOGnqgIAt3qjhnC+WLRu4LKRh3Zw9xk7ZoOWxkJKJvTZ65jau6lkUsGLoPK57Z8FhmaNCqr5asWpq1YK3bgh6Lxn65BrueC4n6KOnfkkazhjLC+s465iB5KeyOE+0vfRbW14cjrurYpd/aeYPQ9xWIY5sw64AAAAASUVORK5CYIIabd521d23fc766a7f1dae898606f5619'); }
	.bCrayon { color: #003870; background-color: #2E8A5C; background-repeat: no-repeat; background-position: center; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAG7AAABuwBHnU4NQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAIISURBVFiFxde7axVBFIDx3yiijdj4hDRaCBY2ahRExULtAin8B2ysRBDsUlv4iqLYCnYiEexSCGKlWEWJiYVBUEQ0gg+UgA8cizsX1nVnk3vvLhmYYncO833zOGfZEGO0nG1Fm5OHEIZCCPdCCGPZoBhjKx1DeIkfiDhfGdcy/BN240qSuNC6QAH+GXsK77sSl1oTKMC/YLhivCtxuXGBAjziVk1cV2K8MYHSyu/UXboUfzvFjDYN34eAGwlwsSL+AL7hBdY3Ci+NXS9fuhJ880BHUAcvxFzrnncVvG+BRVa+BYewOj1fTRK/yvC+BKrgWIXTeJtgEfM4hoP4XQXvWSADH8Zcgj7GCRzBK7yu2va+BDLw41jAT4xhZSH+bpKazcGXLJCBn8QfzGBXJtVmsal27j7hR9OlmsSafuGLCmTg29LzfBnQK7xWIJdqmEhnO5qBzywVnhWoge9P8JtNwCsFcvA0No6vWJuBb+wF/p+AThXLllc8wGQF/Hk/8CqBcymnc7X9PqaxVafCDQSvEniIRzUXcyTlfrfcDgT/R0Cnni+o+IaXJE41BS8L7E0Tf8TODLx75tPYMCi8LHCmsLXvsb1teFlgoiAQ8QY7cBhn24CXBd6VBMr9SdPwGKMQYxRCWJdyX4LNYSr1p5iKMX7QQgtp9UIIIzq/Us9ijN/bgNUKLFf7C6A0pQYwmJNKAAAAAElFTkSuQmCC9c5124cd657ad81a907941e0e45061df'); }
	.bPurple { color: #003870; background-color: #B8008A; }
	.bGreen { color: #003870; background-color: #8BD864; }
	.bYellow { color: #003870; background-color: #FFFF3D; }
	.bBrown { color: #003870; background-color: #A35200; }
	.bZoom:hover { background-color: #CAFF7A; }
	.bNote:hover { background-color: #CCE6FF; }
	.bTool:hover { background-color: #CCE6FF; }
	.bClear:hover { background-color: #FFFFFF; }
	.bEraser:hover { background-color: #FFFFFF; }
	.bMarker:hover { background-color: #3DB87A; }
	.bCrayon:hover { background-color: #3DB87A; }
	.bPurple:hover { background-color: #FF5CAD; }
	.bGreen:hover { background-color: #AFE495; }
	.bYellow:hover { background-color: #FFFF7A; }
	.bBrown:hover { background-color: #E07000; }
</style>

</head>
<body>

<div id="bookDiv">
	<div id="book-zoom">
		<div class="sample-docs">
			<div ignore="1" class="tabs"><div class="left">  </div> <div class="right"> </div></div>
			<div class="hard"></div>	
			<div ignore="1" id="noteDiv"></div>
		</div>
	</div>


	<div id="slider-bar" class="turnjs-slider">
		<div id="slider"></div>
	</div>
</div>

<!-- <div id="noteDiv"></div> -->

<div class="bGroup">
	<!-- <div class="btn bNote" title="檢視附註"></div> -->
	<div class="btn bZoom" title="放大檢視"></div>
	<div class="btn bTool" title="撰寫附註"></div>
	<div class="btn bExt bClear" title="清除畫面"></div>
	<div class="btn bExt bEraser" title="橡皮擦"></div>
	<!--
	<div class="btn bExt bMarker"></div>	
	<div class="btn bExt bCrayon"></div>
	-->
	<div class="btn bExt bPurple" title="桃色筆刷"></div>
	<div class="btn bExt bGreen" title="綠色筆刷"></div>
	<div class="btn bExt bYellow" title="黃色筆刷"></div>
	<div class="btn bExt bBrown" title="棕色筆刷"></div>
</div>

<script type="text/javascript">
function saveCanvas(){
	var page = "page" + getPage(); //$('.sample-docs').turn('page');
	var data = $('#canvas')[0].toDataURL();
	if (typeof (localStorage) !== "undefined") {
		localStorage.setItem(page, data);
	}else{
		alert('Local Storage not supported.');
	}
	console.log('saveCanvas() = ' + page);
}
function loadCanvas(pg) {
	var page = "page" + ((pg != null) ? pg : getPage()); //$('.sample-docs').turn('page'));  
	var context = $('#canvas')[0].getContext('2d');
	/*
	var bgImage = new Image();
	bgImage.onload = function() {
		context.drawImage(this, 0, 0, window.nW, window.nH);
	};
	bgImage.src = './pages/' + pg + '.png';
	*/
	
	var data = localStorage.getItem(page);
	if(data != null){			
		var imageObj = new Image();
		imageObj.onload = function() {
			//fix: size area
			//context.drawImage(this, 0, 0);
			context.drawImage(this, 0, 0, window.nW, window.nH);
		};
		imageObj.src = data;
	}
}
function prepareSize() {
	window.allPages = 26;
	window.viewPages = 2;
	// 1275 x 1651
	var wW, oW = 0;
	var wH, oH = 0;
	var isFs = (window.fullScreen) || (window.innerWidth == screen.width && window.innerHeight == screen.height);
	if(isFs){
		oW = window.screen.width;
		oH = window.screen.height;
		console.log('is fullscreen');
	}else{
		oW = window.innerWidth; //document.documentElement.clientWidth;
		oH = window.innerHeight; //document.documentElement.clientHeight;
	}
	
	wW = oW - 40;
	wH = oH - 40;
	
	if(wW > wH){
		wW = Math.floor(wH * (1275 * window.viewPages) / 1651);
	}else{
		wH = Math.floor(wW * 1651 / (1275 * window.viewPages));
	}
	
	window.nW = wW; // remove button width
	window.nH = wH - 45; // remove slider height
	
	console.log('window.nW = ' + window.nW);
	console.log('window.nH = ' + window.nH);
	
	window.fixLeft = Math.floor((oW - window.nW) / 2);
	
	$('#bookDiv').width(window.nW).height(window.nH).css('left', window.fixLeft);
	//$('#noteDiv').width(window.nW).height(window.nH).css('left', window.fixLeft);
	$('#noteDiv').width(window.nW).height(window.nH);
		
	//$( "#slider" ).width(window.nW);
	//$('.turnjs-slider').width(window.nW)
	
	$('.sample-docs').width(window.nW).height(window.nH);
	$('.sample-docs .page').width(window.nW).height(window.nH);
	$('.sample-docs .tabs').width(window.nW)
	$('.sample-docs .tabs > div').width(window.nW)
	
	canvasWidth = window.nW;
	canvasHeight = window.nH;
	drawingAreaX = 0;
	drawingAreaY = 30;
	drawingAreaWidth = window.nW;
	drawingAreaHeight = window.nH - 60;
	
	$('.turnjs-slider').css({'margin':'0 auto'});
	$('.bGroup').width(window.nW).height(35).css({'left':window.fixLeft,'top':window.nH+10});	
}
function getPage(){	
	return Math.floor($('.sample-docs').turn('page') / window.viewPages) * window.viewPages;
}
function btnEvent(){			
	switch(true){
		case $(this).hasClass('bZoom'):
			if($(this).hasClass('clk')){
				$(this).removeClass('clk');
				stopZoom();
			}else{	
				$(this).addClass('clk');						
				startZoom();
			}
		break;
		case $(this).hasClass('bNote'):
			if($(this).hasClass('clk')){
				$(this).removeClass('clk');
				$('#noteDiv').hide();
				$('.bTool').fadeOut();
				$('.bExt').fadeOut();
				saveCanvas();				
			}else{	
				$(this).addClass('clk');						
				$('#noteDiv').show();
				$('.bTool').fadeIn();	
				loadCanvas();	
			}
		break;
		case $(this).hasClass('bTool'):
			if($(this).hasClass('clk')){
				$(this).removeClass('clk');
				$('.bExt').fadeOut();
				stopDraw();
				$('.sample-docs').turn("disable", false);
			}else{	
				$(this).addClass('clk');						
				$('.bExt').fadeIn();
				startDraw();	
				$('.sample-docs').turn("disable", true);				
			}
			saveCanvas();	
		break;
		case $(this).hasClass('bEraser'):
			curTool = "eraser";
		break;
		case $(this).hasClass('bClear'):
			resetCanvas();
		break;	
		case $(this).hasClass('bMarker'):
			curTool = "marker";
		break;	
		case $(this).hasClass('bCrayon'):
			curTool = "crayon";
		break;	
		case $(this).hasClass('bPurple'):
			curTool = "marker";
			curColor = colorPurple;
		break;	
		case $(this).hasClass('bGreen'):
			curTool = "marker";
			curColor = colorGreen;
		break;	
		case $(this).hasClass('bYellow'):
			curTool = "marker";
			curColor = colorYellow;
		break;	
		case $(this).hasClass('bBrown'):
			curTool = "marker";
			curColor = colorBrown;
		break;	
	}		
}
function loadApp() {
	prepareSize();
	prepareCanvas();
	$('.btn').on('click swipeone', btnEvent);
	
	$('#noteDiv').show();
	loadCanvas();		
	
	var flipbook = $('.sample-docs');

	// Check if the CSS was already loaded
	
	if (flipbook.width()==0 || flipbook.height()==0) {
		setTimeout(loadApp, 10);
		return;
	}

	// Mousewheel

	//$('#book-zoom').mousewheel(function(event, delta, deltaX, deltaY) {		
		/*
		//console.log('deltaX = ' + deltaX);
		console.log('deltaY = ' + deltaY);
						
		var zoom = $('.sample-docs').turn('zoom');
		console.log('Current zoom: ' + zoom);
		
		if(deltaY > 0){
			zoom += 0.1;
		}else if(deltaY < 0){
			zoom -= 0.1;
		}
		zoom = (zoom < 1) ? 1 : zoom;
		zoom = (zoom > 5) ? 5 : zoom;		
		$('.sample-docs').turn('zoom', zoom);
		
		console.log('New zoom: ' + zoom);
		*/
		/*
		var data = $(this).data(),
			step = window.allPages,
			flipbook = $('.sample-docs'),
			actualPos = $('#slider').slider('value')*step;
		
		console.log('actualPos = ' + $('#slider').slider('value')*step);
		console.log('data.scrollX = ' + data.scrollX);
			
		if (typeof(data.scrollX)==='undefined') {
			data.scrollX = actualPos;
			data.scrollPage = flipbook.turn('page');
		}

		data.scrollX = Math.min($( "#slider" ).slider('option', 'max')*step,
			Math.max(0, data.scrollX + deltaX));

		var actualView = Math.round(data.scrollX/step),
			page = Math.min(flipbook.turn('pages'), Math.max(1, actualView*2 - 2));

		if ($.inArray(data.scrollPage, flipbook.turn('view', page))==-1) {
			data.scrollPage = page;
			flipbook.turn('page', page);
		}

		if (data.scrollTimer)
			clearInterval(data.scrollTimer);
		
		data.scrollTimer = setTimeout(function(){
			data.scrollX = undefined;
			data.scrollPage = undefined;
			data.scrollTimer = undefined;
		}, 1000);
		*/
	//});

	// Slider

	$( "#slider" ).slider({
		min: 1,
		max: window.allPages, //100

		start: function(event, ui) {
			/*
			if (!window._thumbPreview) {
				_thumbPreview = $('<div />', {'class': 'thumbnail'}).html('<div></div>');
				setPreview(ui.value);
				_thumbPreview.appendTo($(ui.handle));
			} else
				setPreview(ui.value);
			*/
			stopZoom();
			stopDraw();
			moveBar(false);
		},

		slide: function(event, ui) {
			/*
			setPreview(ui.value);
			*/
		},

		stop: function() {
			/*
			if (window._thumbPreview)
				_thumbPreview.removeClass('show');
			*/
			$('.sample-docs').turn('page', Math.max(1, $(this).slider('value')*2 - 2));
		}
	});


	// URIs
	
	Hash.on('^page\/([0-9]*)$', {
		yep: function(path, parts) {
			var page = parts[1];

			if (page!==undefined) {
				if ($('.sample-docs').turn('is'))
					$('.sample-docs').turn('page', page);
			}

		},
		nop: function(path) {

			if ($('.sample-docs').turn('is'))
				$('.sample-docs').turn('page', 1);
		}
	});

	// Arrows

	$(document).keydown(function(e){

		var previous = 37, next = 39;

		switch (e.keyCode) {
			case previous:

				$('.sample-docs').turn('previous');

			break;
			case next:
				
				$('.sample-docs').turn('next');

			break;
		}

	});

	// Create the flipbook

	flipbook.turn({
		display: 'double', //single , double
		elevation: 50,
		acceleration: false,
		gradients: true,
		autoCenter: true,
		duration: 1000,
		pages: window.allPages,
		when: {

		turning: function(e, page, view) {
			//ext
			stopDraw();
			
			console.log('pg pre = ' + $('.sample-docs').turn('page'));
			saveCanvas();
			resetCanvas();
			console.log('pg now = ' + page);
			loadCanvas(Math.floor(page / window.viewPages) * window.viewPages);
			
			var book = $(this),
			currentPage = book.turn('page'),
			pages = book.turn('pages');
				
			if (currentPage>3 && currentPage<pages-3) {
				if (page==1) {
					book.turn('page', 2).turn('stop').turn('page', page);
					e.preventDefault();
					return;
				} else if (page==pages) {
					book.turn('page', pages-1).turn('stop').turn('page', page);
					e.preventDefault();
					return;
				}
			} else if (page>3 && page<pages-3) {
				if (currentPage==1) {
					book.turn('page', 2).turn('stop').turn('page', page);
					e.preventDefault();
					return;
				} else if (currentPage==pages) {
					book.turn('page', pages-1).turn('stop').turn('page', page);
					e.preventDefault();
					return;
				}
			}
			
			Hash.go('page/'+page).update();
			
			if (page==1 || page==pages){
				$('.sample-docs .tabs').hide();
			}

		},

		turned: function(e, page, view) {

			var book = $(this);

			$('#slider').slider('value', getViewNumber(book, page));
			
			if (page!=1 && page!=book.turn('pages'))
				$('.sample-docs .tabs').fadeIn(500).css('z-index','19999');
			else
				$('.sample-docs .tabs').hide();

			
			book.turn('center');
			updateTabs();

		},

		start: function(e, pageObj) {
	
			moveBar(true);

		},

		end: function(e, pageObj) {
		
			var book = $(this);

			setTimeout(function() {
				$('#slider').slider('value', getViewNumber(book));
			}, 1);

			moveBar(false);

		},

		missing: function (e, pages) {

			for (var i = 0; i < pages.length; i++)
				addPage(pages[i], $(this));

		}
	}
	}). turn('page', 1);


	$('#slider').slider('option', 'max', numberOfViews(flipbook));

	flipbook.addClass('animated');


	// Show canvas

	$('#bookDiv').css({visibility: 'visible'});
}

// Hide canvas

$('#bookDiv').css({visibility: 'hidden'});

yepnope({
	test: Modernizr.csstransforms,
	yep: ['js/lib/turn.min.js', 'css/jquery.ui.css'],
	nope: ['js/lib/turn.html4.min.js', 'css/jquery.ui.html4.css'],
	both: ['css/docs.css', 'js/docs.js','js/drawing.js'],
	complete: loadApp
});

</script>

</body>
</html>